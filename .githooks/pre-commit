#!/usr/bin/env zsh
set -euo pipefail

# Multi-module aware pre-commit hook for Java projects.
# Blocks commits when src/main changes lack corresponding src/test changes.

repo_root_dir="$(git rev-parse --show-toplevel)"
cd "$repo_root_dir"

# Detect staged main Java changes per module
changed_main=($(git diff --cached --name-only --diff-filter=AMR | grep -E '(^|/)src/main/java/.*\.java$' || true))

if [[ ${#changed_main[@]} -eq 0 ]]; then
  exit 0
fi

missing_tests=()
for f in $changed_main; do
  # Extract module dir and package path
  if [[ "$f" =~ ^(.+)/src/main/java/(.+)\.java$ ]]; then
    prefix="${BASH_REMATCH[1]:-${match[1]}}"
    pkg_path="${BASH_REMATCH[2]:-${match[2]}}"
    
    if [[ "$prefix" == "src" ]]; then
      module_dir=""
    else
      module_dir="$prefix"
    fi
  else
    if [[ "$f" =~ ^src/main/java/(.+)\.java$ ]]; then
      module_dir=""
      pkg_path="${BASH_REMATCH[1]:-${match[1]}}"
    else
      continue
    fi
  fi
  
  # Build test paths
  if [[ -n "$module_dir" ]]; then
    test_candidate="${module_dir}/src/test/java/${pkg_path}Test.java"
    alt_candidate="${module_dir}/src/test/java/${pkg_path}Tests.java"
  else
    test_candidate="src/test/java/${pkg_path}Test.java"
    alt_candidate="src/test/java/${pkg_path}Tests.java"
  fi
  
  if [[ ! -f "$test_candidate" && ! -f "$alt_candidate" ]]; then
    missing_tests+="$f"
  fi
done

if [[ ${#missing_tests[@]} -gt 0 ]]; then
  echo "❌ Commit blocked: missing tests for changed source files:" >&2
  for m in $missing_tests; do
    echo "  - $m" >&2
  done

  branch_name="$(git rev-parse --abbrev-ref HEAD)"
  issue_title="Generate tests for branch ${branch_name} (paymentprocessor)"
  issue_body=$(cat <<'EOF'
Pre-commit detected changed Java sources without matching tests.

Please generate unit, Spring slice, integration (Testcontainers), and BDD tests for the changed files.

Changed files:
EOF
  )
  for m in $missing_tests; do
    issue_body+=$'\n- '
    issue_body+="$m"
  done
  issue_body+=$'\n\nPrefer existing frameworks in repo (JUnit 5, Spring Boot Test, Mockito, Cucumber, Testcontainers); otherwise use standard stacks.\n'
  issue_body+=$'\n**IMPORTANT**: Add a clear comment at the top of each generated test file:\n'
  issue_body+=$'```java\n/**\n * Generated by GitHub Copilot Agent\n * Issue: #<issue-number>\n * Date: <generation-date>\n * DO NOT EDIT: This test was auto-generated. Review and modify as needed.\n */\n```\n'
  issue_body+=$"\nBranch: ${branch_name}\nRepository: paymentprocessor\n"

  if command -v gh >/dev/null 2>&1; then
    existing_id=$(gh issue list --search "$issue_title" --state open --json number --jq '.[0].number' 2>/dev/null || true)
    if [[ -n "$existing_id" ]]; then
      gh issue comment "$existing_id" --body "$issue_body" || true
      gh issue edit "$existing_id" --add-assignee @copilot || true
    else
      gh issue create --title "$issue_title" --body "$issue_body" --assignee @copilot || true
    fi
  fi

  echo "" >&2
  echo "⚠️  WARNING: Committing without tests. GitHub Issue created for Copilot Agent." >&2
  echo "Copilot will generate tests automatically in a separate PR." >&2
  echo "" >&2
fi

exit 0
